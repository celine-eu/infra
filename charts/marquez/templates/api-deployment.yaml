---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "marquez.fullname" . }}-api
  labels:
    app.kubernetes.io/name: marquez-api
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/name: marquez-api
  template:
    metadata:
      labels:
        app.kubernetes.io/name: marquez-api
    spec:
      containers:
        - name: marquez-api
          image: {{ .Values.image.api }}
          imagePullPolicy: IfNotPresent
          env:
            - name: MARQUEZ_PORT
              value: "5000"
            - name: MARQUEZ_ADMIN_PORT
              value: "5001"
            - name: MARQUEZ_CONFIG
              value: /usr/src/app/marquez.yaml
            - name: POSTGRES_HOST
              value: {{ .Values.postgres.host | quote }}
            - name: POSTGRES_PORT
              value: {{ .Values.postgres.port | quote }}
            - name: POSTGRES_DB
              value: {{ .Values.postgres.database | quote }}
            - name: POSTGRES_USER
              value: {{ .Values.postgres.user | quote }}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.postgres.existingSecret }}
                  key: {{ .Values.postgres.existingSecretKey }}
            - name: SEARCH_ENABLED
              value: {{ ternary "true" "false" .Values.search.enabled | quote }}
            - name: SEARCH_HOST
              value: {{ .Values.search.host | quote }}
            - name: SEARCH_PORT
              value: {{ .Values.search.port | quote }}
           # JVM tuning: explicit heap + G1GC to avoid GC pauses causing slow responses
            - name: JAVA_OPTS
              value: {{ .Values.javaOpts | default "-Xms512m -Xmx1536m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+ExitOnOutOfMemoryError" | quote }}

          ports:
            - containerPort: 5000
            - containerPort: 5001
          volumeMounts:
            - name: marquez-data
              mountPath: /opt/marquez
            - name: marquez-config
              mountPath: /usr/src/app/marquez.yaml
              subPath: marquez.yaml

          # Dropwizard JVM startup is slow â€” give it time before probing.
          # /healthcheck on the admin port returns 200 only when fully ready.
          readinessProbe:
            httpGet:
              path: /healthcheck
              port: 5001
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
            successThreshold: 1

          livenessProbe:
            httpGet:
              path: /healthcheck
              port: 5001
            initialDelaySeconds: 60   # longer: liveness failure triggers a restart
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 5

          startupProbe:
            # Blocks liveness/readiness until the JVM has fully started.
            # Gives up to 60 * 5s = 5 minutes before killing the pod.
            httpGet:
              path: /healthcheck
              port: 5001
            initialDelaySeconds: 20
            periodSeconds: 5
            failureThreshold: 60


      volumes:
        - name: marquez-data
          {{- if .Values.persistence.enabled }}
          persistentVolumeClaim:
            claimName: {{ include "marquez.fullname" . }}-data
          {{- else }}
          emptyDir: {}
          {{- end }}
        - name: marquez-config
          configMap:
            name: {{ include "marquez.fullname" . }}-config
