apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mosquitto-go-auth.fullname" . }}-config
  labels:
    {{- include "mosquitto-go-auth.labels" . | nindent 4 }}
data:
  mosquitto.conf: |
    # Generated by charts/mosquitto-go-auth â€” edit values.yaml, not this file.

    listener {{ .Values.listeners.mqtt.port }}
    protocol mqtt

    listener {{ .Values.listeners.websocket.port }}
    protocol websockets

    persistence {{ .Values.mosquitto.persistence | ternary "true" "false" }}
    persistence_location {{ .Values.mosquitto.persistenceLocation }}

    log_dest {{ .Values.mosquitto.logDest }}
    log_type {{ .Values.mosquitto.logType }}

    max_inflight_messages {{ .Values.mosquitto.maxInflightMessages }}
    max_queued_messages   {{ .Values.mosquitto.maxQueuedMessages }}

    allow_anonymous {{ .Values.mosquitto.allowAnonymous | ternary "true" "false" }}

    # -------------------------------------------------------------------------
    # mosquitto-go-auth plugin
    # -------------------------------------------------------------------------
    auth_plugin /mosquitto/go-auth.so

    auth_opt_log_level {{ .Values.goAuth.logLevel }}
    auth_opt_log_dest  {{ .Values.goAuth.logDest }}

    {{- if .Values.goAuth.disableSuperuser }}
    auth_opt_disable_superuser true
    {{- end }}

    # Backends tried in order: jwt first, files fallback for legacy clients
    auth_opt_backends {{ include "mosquitto-go-auth.backends" . }}

    # -------------------------------------------------------------------------
    # JWT remote backend
    # -------------------------------------------------------------------------
    auth_opt_jwt_mode         remote
    auth_opt_jwt_host         {{ .Values.goAuth.jwt.host }}
    auth_opt_jwt_port         {{ .Values.goAuth.jwt.port }}
    auth_opt_jwt_http_timeout {{ .Values.goAuth.jwt.httpTimeout }}

    auth_opt_jwt_getuser_uri   {{ .Values.goAuth.jwt.getUserUri }}
    auth_opt_jwt_aclcheck_uri  {{ .Values.goAuth.jwt.aclUri }}
    auth_opt_jwt_superuser_uri {{ .Values.goAuth.jwt.superuserUri }}

    {{- if .Values.goAuth.files.enabled }}
    # -------------------------------------------------------------------------
    # Files backend (legacy username/password clients)
    # Password and ACL files are mounted from the auth-files Secret.
    # -------------------------------------------------------------------------
    auth_opt_files_password_path /etc/mosquitto/auth/passwd
    auth_opt_files_acl_path      /etc/mosquitto/auth/acl
    {{- end }}

    # -------------------------------------------------------------------------
    # Redis decision cache
    # -------------------------------------------------------------------------
    auth_opt_cache         {{ .Values.goAuth.cache.enabled | ternary "true" "false" }}
    auth_opt_cache_reset   {{ .Values.goAuth.cache.reset   | ternary "true" "false" }}
    auth_opt_cache_refresh {{ .Values.goAuth.cache.refresh | ternary "true" "false" }}

    auth_opt_cache_type {{ .Values.goAuth.cache.type }}
    auth_opt_cache_host {{ .Values.goAuth.cache.host }}
    auth_opt_cache_port {{ .Values.goAuth.cache.port }}
    auth_opt_cache_db   {{ .Values.goAuth.cache.db }}
    {{- if .Values.goAuth.cache.password }}
    auth_opt_cache_password {{ .Values.goAuth.cache.password }}
    {{- end }}

    auth_opt_auth_cache_seconds  {{ .Values.goAuth.cache.authCacheSeconds }}
    auth_opt_acl_cache_seconds   {{ .Values.goAuth.cache.aclCacheSeconds }}
    auth_opt_auth_jitter_seconds {{ .Values.goAuth.cache.authJitterSeconds }}
    auth_opt_acl_jitter_seconds  {{ .Values.goAuth.cache.aclJitterSeconds }}
