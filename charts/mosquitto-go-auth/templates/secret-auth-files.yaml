{{- if .Values.goAuth.files.enabled }}
{{- /*
  Renders passwd and acl files from .Values.users into a Secret.
  Mounted read-only at /etc/mosquitto/auth/ in the broker container.

  passwd format:  username:sha512-pbkdf2-hash
  acl format:     user <username>
                  topic <access> <topic>

  Passwords are generated with: task mqtt:passwd
  (wraps mosquitto_passwd -H sha512-pbkdf2)

  This Secret is updated on every helm upgrade when users or passwords
  change â€” go-auth reloads the files backend automatically on SIGHUP,
  which the pod restart on checksum change triggers.
*/}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "mosquitto-go-auth.fullname" . }}-auth-files
  labels:
    {{- include "mosquitto-go-auth.labels" . | nindent 4 }}
type: Opaque
stringData:
  passwd: |
    {{- include "mosquitto-go-auth.passwdFile" . | nindent 4 }}
  acl: |
    {{- include "mosquitto-go-auth.aclFile" . | nindent 4 }}
{{- end }}
